FROM mcr.microsoft.com/playwright:v1.41.0-jammy

WORKDIR /app

# 1. Install dependencies
COPY package*.json ./
# Install only production dependencies if possible, but we need typescript to build or we just copy build artifacts
# Better: Build locally or in a build stage and copy dist.
# For simplicity with the constraints: "Minimal required project files".

# Let's do a multi-stage approach to keep final image clean?
# OR just copy what we need.

RUN npm install

# 2. Copy source and config
COPY tsconfig.json .
COPY src ./src
COPY data ./data

# 3. Build TypeScript to dist
RUN npm run build

# 4. Remove source files that are not needed for execution (optional cleanup)
# Keeping features and data as requested
# We can remove src/ai if strictly not needed in runner, but depends on imports.
# 'dist' has the JS. 'features' has the Gherkin.

# Prune dev dependencies to save space (if validation allows)
# RUN npm prune --production

# 5. Set Environment
ENV NODE_ENV=production
ENV HEADLESS_TEST=true
# Ensure we use the installed browsers from the base image

CMD ["npm", "run", "test"]
